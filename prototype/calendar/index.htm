<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='fullcalendar.css' rel='stylesheet' />
<script src='moment.min.js'></script>
<script src='jquery.min.js'></script>
<script src='jquery-ui.min.js'></script>
<script src='fullcalendar.js'></script>
<script src='lang-all.js'></script>
<script src='jquery.ui.touch.js'></script>

<script>

function exacomp_calendar_update_event(event) {
	var event = exacomp_calcendar.event_slot_to_time(event);
	console.log('event change', event.start, event.end);

	/*
	var title = event.title;
	var start = event.start.format();
	var end = (event.end == null) ? start : event.end.format();

	u$.ajax({
	 url: 'process.php',
	 data: 'type=resetdate&title='+title+'&start='+start+'&end='+end+'&eventid='+id,
	 type: 'POST',
	 dataType: 'json',
	 success: function(response){
	   if(response.status != 'success')
	   revertFunc();
	 },
	 error: function(e){
	   revertFunc();
	   alert('Error processing your request: '+e.responseText);
	 }
	 });
	*/
}

var exacomp_calcendar_config = {
	slots: [
		{
			name: '1. Einheit',
			start: '08:00',
			end: '08:25'
		}, {
			name: '',
			start: '08:25',
			end: '08:50'
		}, {
			name: '2. Einheit',
			start: '08:55',
			end: '09:20'
		}, {
			name: '',
			start: '09:20',
			end: '09:45'
		}, {
			name: '3. Einheit',
			start: '10:00',
			end: '10:25'
		}, {
			name: '',
			start: '10:25',
			end: '11:50'
		}, {
			name: 'test Einheit',
			start: '10:00',
			end: '13:25'
		}, {
			name: '3. Einheit',
			start: '10:00',
			end: '14:15'
		}, {
			name: '3. Einheit',
			start: '10:00',
			end: '14:20'
		}, {
			name: '8. Einheit',
			start: '10:00',
			end: '14:25'
		}
	]
};

exacomp_calcendar = {
	event_slot_to_time: function(origEvent) {
		// clone event
		event = $.extend({}, origEvent);
		
		event.start = this.slot_to_time(event.start, 'start');
		if (event.end) {
			event.end = this.slot_to_time(event.end, 'end');
		} else {
			// get end time from start time
			var nextSlot = moment(origEvent.start).add(1, 'minute');
			event.end = this.slot_to_time(nextSlot, 'end');
		}
		return event;
	},
	event_time_to_slot: function(origEvent) {
		// clone event
		event = $.extend({}, origEvent);
		
		event.start = this.time_to_slot(event.start, 'start');
		if (event.end) event.end = this.time_to_slot(event.end, 'end');
		return event;
	},
	slot_to_time: function(time, type /* start or end */ ) {
		var m = moment(time);
		
		var slot = exacomp_calcendar_config.slots[m.add(type == 'end' ? -1 : 0, 'minute').format('m')];
		if (!slot) {
			console.log('WARNING: Slot not found', time.format(), type);
			slot = exacomp_calcendar_config.slots[0];
		}
		
		return m.format('YYYY-MM-DD')+' '+slot[type];
	},
	time_to_slot: function(time, type /* start or end */ ) {
		var m = moment(time);
		var time = m.format('HH:mm');
		var found_slot_i = null;

		$.each(exacomp_calcendar_config.slots, function(i, slot) {
			if (time == slot[type]) {
				found_slot_i = i;
			}
		});
		
		if (found_slot_i === null) {
			console.log('WARNING: Slot not found', time, type);
			found_slot_i = 0;
		}
		
		return m.format('YYYY-MM-DD')+' 00:'+(type == 'end' ? found_slot_i+1 : found_slot_i)+':00';
	}
};

var eventsFromMoodle = [
	{
		title: 'Test Event',
		start: '2015-08-18 08:00:00',
		end: '2015-08-18 08:50:00'
	},
	{
		title: 'test Event',
		start: '2015-08-19 10:25:00'
	},
	{
		title: 'Long event',
		start: '2015-08-18 8:25:00',
		end: '2015-08-18 13:25:00'
	}
];

// testing:
/*
var events = $.map(eventsFromMoodle, function(o){ return exacomp_calcendar.event_time_to_slot(o); })
console.log(events);
var events = $.map(eventsFromMoodle, function(o){ return exacomp_calcendar.event_slot_to_time(o); })
console.log(events);
*/

$(document).ready(function() {

	/* initialize the external events
	-----------------------------------------------------------------*/

	function init_external_event(el) {
		el = $(el);
		el.draggable({
		  zIndex: 999,
		  revert: true, 
		  revertDuration: 0 
		});
		el.addTouch();
	}
	$('#external-events .fc-event').each(function() {

		// store data so the calendar knows to render an event upon drop
		$(this).data('event', {
			title: $.trim($(this).text()), // use the element's text as the event title
			stick: true // maintain when user navigates (see docs on the renderEvent method)
		});

		// make the event draggable using jQuery UI
		init_external_event(this);
	});


	/* initialize the calendar
	-----------------------------------------------------------------*/
	var $eventDiv = $( '#external-events' );
	var $trash = $( '#trash' );
	
	$trash.droppable({
		// accept: ".special"
		drop: function(event, ui ) {
			if (confirm('Wirklich löschen?')) {
				ui.draggable.remove();
			}
		},
		
		hoverClass: 'hover',
	});
	
	function hover_check(e) {
		if (e && isEventOverDiv($eventDiv, e)) {
			$eventDiv.addClass('hover');
		} else {
			$eventDiv.removeClass('hover');
		}

		if (e && isEventOverDiv($trash, e)) {
			$trash.addClass('hover');
		} else {
			$trash.removeClass('hover');
		}
	}
	
	function isEventOverDiv($div, event) {

		var x = event.pageX, y = event.pageY;
		var offset = $div.offset();
		offset.right = $div.outerWidth() + offset.left;
		offset.bottom = $div.outerHeight() + offset.top;

		// Compare
		return (x >= offset.left
			&& y >= offset.top
			&& x <= offset.right
			&& y <= offset .bottom);
	}

	$('#calendar').fullCalendar({
		header: {
			left: 'today prev,next',
			center: 'title',
			right: 'month,agendaWeek,agendaDay'
		},
		lang: 'de',
		defaultView: 'agendaWeek',
		minTime: "00:00:00",
		maxTime: "00:"+exacomp_calcendar_config.slots.length+":00",
		axisWidth: 40,
		slotDuration: "00:01:00",
		hiddenDays: [ 0, 6 ], // no sunday and saturday
		allDaySlot: false,
		defaultTimedEventDuration: '00:01:00', // default event length
		
		contentHeight: "auto",
		
		eventConstraint: {
			start: '00:00:00', // a start time (10am in this example)
			end: "00:"+exacomp_calcendar_config.slots.length+":00"
		},

		editable: true,
		droppable: true, // this allows things to be dropped onto the calendar
		dragRevertDuration: 0,
		
		/*
		drop: function() {
			$(this).remove();
		},
		*/
		
		events: $.map(eventsFromMoodle, function(o){ return exacomp_calcendar.event_time_to_slot(o); }),
		
		eventRender: function(event, element) {
			// console.log(element.html());
			element.find(".fc-time").remove();
			// element.find(".fc-event-time").remove();
			element.find(".fc-content").append(
				'	<div class="event-extra">' +
				'	<div>L: <input type="checkbox" /> S: <input type="checkbox" /></div>' +
				'	<div><a href="#">edit</a></div>' +
				'</div>');
			
			$(element).addTouch();
		},
		
		eventDragStart: function() {
			$("html").bind('mousemove', hover_check);
		},
		
		eventDragStop: function( event, jsEvent, ui, view ) {
			$("html").unbind('mousemove', hover_check);
			hover_check(false);
		
			// console.log(jsEvent);
			if(isEventOverDiv($eventDiv, jsEvent)) {
				$('#calendar').fullCalendar('removeEvents', event._id);
				var el = $( "<div class='fc-event'>" ).appendTo( $eventDiv ).text( event.title );
				el.data('event', { title: event.title, id :event.id, stick: true });
				
				init_external_event(el);
			}

			if(isEventOverDiv($trash, jsEvent)) {
				if (confirm('Wirklich löschen?')) {
					$('#calendar').fullCalendar('removeEvents', event._id);
				}
			}
		},
		
		viewRender: function(view, element) {
			// reset axis labels
			var i = 0, einheit = 0;
			element.find('.fc-time span').each(function(){
				this.innerHTML = exacomp_calcendar_config.slots[i].name;
				i++;
				/*
				if (einheit%2)
					$(this).closest('tr').css('background-color', 'rgba(255, 0, 0, 0.2)');
				*/
			});
			
			view.updateSize();
		},
		
		eventResize: function(event, delta, revertFunc) {
			exacomp_calendar_update_event(event);
		},
		eventDrop: function(event, delta, revertFunc) {
			exacomp_calendar_update_event(event);
		},
		/*
			Called when an external element, containing event data, is dropped on the calendar.
		*/
		eventReceive: function(event) {
			exacomp_calendar_update_event(event);
		},
		/*
		eventDrop: function(event, delta, revertFunc) {
		
			// TODO: only allow moving event before 1am and 10am
			return;
			console.log(event.start, event.end);
			var eventStartSlot = event.start.format('H');
			var eventEndSlot = event.end ? event.end.format('H') : (eventStartSlot /* it's a string * / * 1 + 1); // new dragged in events have no end
			console.log(event.start, event.end, eventStartSlot, eventEndSlot);
			
			if (eventStartSlot >= 1 && eventStartSlot <= 10
				&& eventEndSlot >= 1 && eventEndSlot <= 10) {
				// ok
			} else {
				return revertFunc();
			}
		}
		*/
	});
	
	// restrict
	
});

</script>
<style>

	.fc-time-grid .fc-slats td {
		height: 5em;
	}
	
	body {
		margin-top: 40px;
		text-align: center;
		font-size: 14px;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
	}
		
	#wrap {
		width: 1100px;
		margin: 0 auto;
	}
		
	#external-events {
		float: left;
		width: 150px;
		padding: 0 10px;
		border: 1px solid #ccc;
		background: #eee;
		text-align: left;
	}
	#external-events.hover {
		background: blue;
	}
	
	#trash {
		float: left;
		width: 150px;
		padding: 0 10px;
		border: 1px solid #ccc;
		background: #eee;
		text-align: left;
		margin-top: 20px;
	}
	#trash.hover {
		background: blue;
	}

	#external-events h4 {
		font-size: 16px;
		margin-top: 0;
		padding-top: 1em;
	}
		
	#external-events .fc-event {
		margin: 10px 0;
		cursor: pointer;
		min-height: 50px;
	}
	.fc-event .event-extra {
		border-top: 1px solid white;
		margin-top: 5px;
		padding: 5px;
	}
	
	#external-events p {
		margin: 1.5em 0;
		font-size: 11px;
		color: #666;
	}
		
	#external-events p input {
		margin: 0;
		vertical-align: middle;
	}

	#calendar {
		float: right;
		width: 900px;
	}

</style>
</head>
<body>
	<div id='wrap'>

		<div id='external-events'>
			<h4>Events</h4>
			<div class='fc-event'>My Event 1</div>
			<div class='fc-event'>My Event 2</div>
			<div class='fc-event'>My Event 3</div>
			<div class='fc-event'>My Event 4</div>
			<div class='fc-event'>My Event 5</div>
		</div>

		<div id='calendar'></div>

		<div id='trash'>
			<h4>Papierkorb</h4>
		</div>

		<div style='clear:both'></div>

	</div>
</body>
</html>
